name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Python syntax
        run: python -m py_compile app.py

  test:
    needs: validate                # Jookseb AINULT kui validate läbib
    runs-on: ubuntu-latest         # Iga job saab puhtalt uue VM'i
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'             # Vahemälustab pip pakette (kiirendab)

      - name: Install dependencies
        run: pip install -r requirements.txt  # Flask + pytest

      - name: Run tests
        run: pytest test_app.py -v  # -v = verbose, näitab iga testi tulemust

  build:
    needs: test                    # Jookseb ainult kui testid läbivad
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Ainult main branch (mitte PR'id)
    permissions:                   # Õigused GHCR'i push'imiseks
      contents: read               # Repo sisu lugemine
      packages: write              # Container registry kirjutamine
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io        # GitHub'i enda container registry
          username: ${{ github.actor }}      # Automaatne: kes push'is
          password: ${{ secrets.GITHUB_TOKEN }}  # Automaatne: GitHub'i token

      - name: Build Docker image
        run: |
          IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}"  # ,, = lowercase (GHCR nõuab)
          docker build -t $IMAGE:${{ github.sha }} .  # Tag commit hash'iga (unikaalne)
          docker build -t $IMAGE:latest .             # Tag latest (mugavuse jaoks)

      - name: Test Docker image
        run: |
          IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}":${{ github.sha }}
          docker run -d -p 5000:5000 --name test-container $IMAGE  # Käivitab konteineri
          sleep 5                  # Ootab et rakendus jõuaks käivituda

          if curl -f http://localhost:5000/health; then  # -f = fail on HTTP error
            echo "Health check passed"
          else
            echo "Health check FAILED"
            docker logs test-container  # Näitab miks konteiner crashis
            exit 1                     # Lõpetab pipeline punasega
          fi

          docker stop test-container
          docker rm test-container     # Koristab pärast testi

      - name: Push Docker image
        run: |
          IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}"
          docker push $IMAGE:${{ github.sha }}  # Push'ib mõlemad tag'id
          docker push $IMAGE:latest
